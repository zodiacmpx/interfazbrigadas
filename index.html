<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Brigadas Eléctricas en Chile</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* General styles */
        body {
            overflow: hidden;
        }

        #map {
            height: 100vh;
        }

        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            padding: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
            background-color: #f8f9fa;
            width: 300px;
        }

        .sidebar .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 0px);
            padding-top: 20px;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .sidebar-heading {
            padding: 0.75rem 1rem;
            font-size: 1.2rem;
            text-align: center;
        }

        #brigade-list .list-group-item {
            cursor: pointer;
        }

        #brigade-list .brigade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #brigade-list .brigade-info {
            font-size: 0.9rem;
            color: #555;
            margin-top: 5px;
        }

        #map {
            margin-left: 300px; /* Width of the sidebar */
        }

        #details-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 350px;
            display: none;
            z-index: 1001;
        }

        @media (max-width: 768px) {
            #map {
                margin-left: 0;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            #details-panel {
                width: 90%;
            }
        }

        /* Estilos para el KPI */
        .kpi-value {
            font-weight: bold;
        }

        .kpi-low {
            color: red;
        }

        .kpi-medium {
            color: orange;
        }

        .kpi-high {
            color: green;
        }

        /* Styles for activated brigades */
        .activated {
            background-color: #e9f7ef; /* Light green background */
        }

        /* Highlighted marker */
        .highlight-marker {
            transform: scale(1.5);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="sidebar-sticky">
                    <h5 class="sidebar-heading">Brigadas Disponibles</h5>
                    <input type="text" id="search-input" class="form-control mb-3" placeholder="Buscar brigada...">
                    <ul id="brigade-list" class="list-group">
                        <!-- Lista de brigadas -->
                    </ul>
                </div>
            </nav>
            <!-- Main Content -->
            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-0">
                <div id="map"></div>
                <!-- Panel de detalles -->
                <div id="details-panel" class="card">
                    <div class="card-header">
                        <h5 id="brigade-name">Nombre de la Brigada</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Estado:</strong> <span id="brigade-status"></span></p>
                        <p><strong>Velocidad de traslado:</strong> <span id="brigade-speed"></span></p>
                        <p><strong>KPI:</strong> <span id="brigade-kpi" class="kpi-value"></span></p>
                        <p><strong>OA Activada:</strong> <span id="brigade-oa"></span></p>
                        <p><strong>Dentro de plazo según densidad:</strong> <span id="brigade-plazo"></span></p>
                        <p><strong>Alertas/Notificaciones:</strong> <span id="brigade-alertas"></span></p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
    <!-- Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Custom JS -->
    <script>
        // Datos de ejemplo para las brigadas en Chile
        const brigades = [
            // Brigadas en Valdivia
            {
                id: 1,
                name: "Brigada Valdivia 1",
                coords: [-39.8196, -73.2452],
                speed: 55,
                kpi: 92,
                estado: "En traslado",
                oaActivada: "Sí",
                plazo: "Dentro de plazo",
                alertas: "Sin alertas",
                path: [
                    [-39.8196, -73.2452],
                    [-39.8296, -73.2552],
                    [-39.8396, -73.2652],
                    [-39.8496, -73.2752],
                    [-39.8596, -73.2852]
                ]
            },
            {
                id: 2,
                name: "Brigada Valdivia 2",
                coords: [-39.8142, -73.2451],
                speed: 60,
                kpi: 70,
                estado: "Trabajando en el lugar",
                oaActivada: "No",
                plazo: "Fuera de plazo",
                alertas: "Retraso en llegada",
                path: [
                    [-39.8142, -73.2451],
                    [-39.8242, -73.2551],
                    [-39.8342, -73.2651],
                    [-39.8442, -73.2751],
                    [-39.8542, -73.2851]
                ]
            },
            // Brigadas en Osorno
            {
                id: 3,
                name: "Brigada Osorno 1",
                coords: [-40.5741, -73.1144],
                speed: 52,
                kpi: 88,
                estado: "En traslado",
                oaActivada: "No",
                plazo: "Dentro de plazo",
                alertas: "Sin alertas",
                path: [
                    [-40.5741, -73.1144],
                    [-40.5841, -73.1244],
                    [-40.5941, -73.1344],
                    [-40.6041, -73.1444],
                    [-40.6141, -73.1544]
                ]
            },
            {
                id: 4,
                name: "Brigada Osorno 2",
                coords: [-40.5690, -73.1120],
                speed: 57,
                kpi: 65,
                estado: "Trabajando en el lugar",
                oaActivada: "Sí",
                plazo: "Dentro de plazo",
                alertas: "Sin alertas",
                path: [
                    [-40.5690, -73.1120],
                    [-40.5790, -73.1220],
                    [-40.5890, -73.1320],
                    [-40.5990, -73.1420],
                    [-40.6090, -73.1520]
                ]
            },
            // Brigadas en Temuco
            {
                id: 5,
                name: "Brigada Temuco 1",
                coords: [-38.7359, -72.5901],
                speed: 60,
                kpi: 85,
                estado: "En traslado",
                oaActivada: "Sí",
                plazo: "Dentro de plazo",
                alertas: "Sin alertas",
                path: [
                    [-38.7359, -72.5901],
                    [-38.7459, -72.6001],
                    [-38.7559, -72.6101],
                    [-38.7659, -72.6201],
                    [-38.7759, -72.6301]
                ]
            },
            {
                id: 6,
                name: "Brigada Temuco 2",
                coords: [-38.7400, -72.5950],
                speed: 58,
                kpi: 78,
                estado: "Trabajando en el lugar",
                oaActivada: "No",
                plazo: "Fuera de plazo",
                alertas: "Retraso en inicio",
                path: [
                    [-38.7400, -72.5950],
                    [-38.7500, -72.6050],
                    [-38.7600, -72.6150],
                    [-38.7700, -72.6250],
                    [-38.7800, -72.6350]
                ]
            },
            // Más brigadas en Osorno
            {
                id: 7,
                name: "Brigada Osorno 3",
                coords: [-40.5639, -73.1096],
                speed: 54,
                kpi: 45,
                estado: "En colación",
                oaActivada: "No",
                plazo: "Fuera de plazo",
                alertas: "Demora en respuesta",
                path: [
                    [-40.5639, -73.1096],
                    [-40.5739, -73.1196],
                    [-40.5839, -73.1296],
                    [-40.5939, -73.1396],
                    [-40.6039, -73.1496]
                ]
            },
            // Puedes agregar más brigadas si lo deseas
        ];

        // Inicializar el mapa centrado en la zona sur de Chile
        const map = L.map('map').setView([-39.5, -72.5], 7);

        // Añadir capa de mapa
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Referencia para los marcadores de brigadas en el mapa
        const brigadeMarkers = {};

        // Función para determinar el color del KPI
        function getKpiColor(kpi) {
            if (kpi >= 80) {
                return 'kpi-high'; // Verde
            } else if (kpi >= 50) {
                return 'kpi-medium'; // Naranja
            } else {
                return 'kpi-low'; // Rojo
            }
        }

        // Función para agregar brigada al mapa
        function addBrigadeToMap(brigade) {
            const customIcon = L.icon({
                iconUrl: 'https://img.icons8.com/color/48/000000/electricity.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32],
            });

            const marker = L.marker(brigade.coords, { icon: customIcon }).addTo(map);

            // Agregar indicadores al marcador
            const popupContent = 
                `<strong>${brigade.name}</strong><br>
                Estado: ${brigade.estado}<br>
                Velocidad: ${brigade.speed} km/h<br>
                KPI: <span class="${getKpiColor(brigade.kpi)}">${brigade.kpi}%</span>`;
            marker.bindPopup(popupContent);

            // Almacenar el marcador para futuras referencias
            brigadeMarkers[brigade.id] = marker;

            // Evento al hacer clic en el marcador
            marker.on('click', function () {
                showDetails(brigade);
            });
        }

        // Función para activar brigada desde la lista
        function activateBrigade(id) {
            const brigade = brigades.find(b => b.id === id);
            if (brigade) {
                // Evitar agregar marcadores duplicados
                if (!brigadeMarkers[brigade.id]) {
                    addBrigadeToMap(brigade);
                    // Marcar la brigada como activada en la lista
                    const listItem = document.getElementById('brigade-item-' + id);
                    listItem.classList.add('activated');
                }
            }
        }

        // Cargar lista de brigadas
        function loadBrigadeList() {
            const listElement = document.getElementById('brigade-list');
            brigades.forEach(brigade => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.id = 'brigade-item-' + brigade.id;

                const headerDiv = document.createElement('div');
                headerDiv.className = 'brigade-header';

                const nameSpan = document.createElement('span');
                nameSpan.textContent = brigade.name;

                const addButton = document.createElement('button');
                addButton.textContent = "Activar";
                addButton.className = "btn btn-primary btn-sm";
                addButton.onclick = (event) => {
                    event.stopPropagation();
                    activateBrigade(brigade.id);
                };

                headerDiv.appendChild(nameSpan);
                headerDiv.appendChild(addButton);

                // Información adicional debajo del nombre
                const infoDiv = document.createElement('div');
                infoDiv.className = 'brigade-info';
                infoDiv.innerHTML = `
                    KPI: <span class="${getKpiColor(brigade.kpi)}">${brigade.kpi}%</span><br>
                    Estado: ${brigade.estado}
                `;

                listItem.appendChild(headerDiv);
                listItem.appendChild(infoDiv);
                listElement.appendChild(listItem);

                // Evento al pasar el mouse sobre el elemento de la lista
                listItem.addEventListener('mouseenter', () => {
                    // Resaltar el marcador en el mapa si está activado
                    if (brigadeMarkers[brigade.id]) {
                        brigadeMarkers[brigade.id].getElement().classList.add('highlight-marker');
                    }
                });

                listItem.addEventListener('mouseleave', () => {
                    if (brigadeMarkers[brigade.id]) {
                        brigadeMarkers[brigade.id].getElement().classList.remove('highlight-marker');
                    }
                });

                // Evento al hacer clic en el elemento de la lista
                listItem.addEventListener('click', () => {
                    // Si la brigada está activada, mostrar detalles en el panel
                    if (listItem.classList.contains('activated')) {
                        showDetails(brigade);
                    }
                });
            });
        }

        // Mostrar detalles de la brigada
        function showDetails(brigade) {
            document.getElementById('brigade-name').textContent = brigade.name;
            document.getElementById('brigade-status').textContent = brigade.estado;
            document.getElementById('brigade-speed').textContent = brigade.speed + ' km/h';

            const kpiElement = document.getElementById('brigade-kpi');
            kpiElement.textContent = brigade.kpi + '%';
            kpiElement.className = 'kpi-value ' + getKpiColor(brigade.kpi);

            document.getElementById('brigade-oa').textContent = brigade.oaActivada;
            document.getElementById('brigade-plazo').textContent = brigade.plazo;
            document.getElementById('brigade-alertas').textContent = brigade.alertas;

            // Mostrar el panel de detalles
            document.getElementById('details-panel').style.display = 'block';

            // Centrar el mapa en la brigada
            if (brigadeMarkers[brigade.id]) {
                map.setView(brigadeMarkers[brigade.id].getLatLng(), 13);
                // Abrir el popup
                brigadeMarkers[brigade.id].openPopup();
            }
        }

        // Filtrar brigadas
        function filterBrigades() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const listItems = document.querySelectorAll('#brigade-list .list-group-item');
            listItems.forEach(item => {
                const brigadeName = item.querySelector('.brigade-header span').textContent.toLowerCase();
                if (brigadeName.includes(query)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Evento de búsqueda
        document.getElementById('search-input').addEventListener('input', filterBrigades);

        // Inicializar la aplicación
        loadBrigadeList();
    </script>
</body>
</html>

